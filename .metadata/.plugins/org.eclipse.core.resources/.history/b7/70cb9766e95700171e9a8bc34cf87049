package bitcamp.java93.dao.mysql;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import bitcamp.java93.dao.TeacherDao;
import bitcamp.java93.domain.Teacher;
import bitcamp.java93.util.DBConnectionPool;

@Component
public class TeacherDaoImpl implements TeacherDao{
  @Autowired
  DBConnectionPool conPool;
  
  
  public List<Teacher> list(int pageNo, int pageSize) throws Exception {
    HashMap<String, Object> valueMap = new HashMap<>();
    valueMap.put("startIndex", (pageNo - 1) * pageSize);
    valueMap.put("pageSize", pageSize);
    
   return teacherDao.selectList(valueMap);
        

  }
  
  public List<String> selectPhotoList(int teacherNo) throws Exception {
    
    Connection con = conPool.getConnection();
    
    try ( 
        PreparedStatement stmt = con.prepareStatement(
            "select path from tch_phot where tno=?");) {
      
        stmt.setInt(1, teacherNo);
        
        ArrayList<String> list = new ArrayList<>();
        
        try (ResultSet rs = stmt.executeQuery();) {
        
        while (rs.next()) { 
          list.add(rs.getString("path"));
          }
        }
        return list;
        
      } finally {
        conPool.returnConnection(con);
      }

  }
  public Teacher selectOne(int no) throws Exception {
    Connection con = conPool.getConnection();
    
    try ( 
        PreparedStatement stmt = con.prepareStatement(
            "select m.mno, m.name, m.tel, m.email, t.hmpg, t.fcbk, t.twit" +
            " from tcher t inner join memb m on t.tno=m.mno " +
            " where t.tno=?");) {
      
        stmt.setInt(1, no);
        
        try (ResultSet rs = stmt.executeQuery();) {
        
        if (!rs.next())  
          return null;
          
        Teacher teacher = new Teacher();
        teacher.setNo(rs.getInt("mno")); 
        teacher.setName(rs.getString("name")); 
        teacher.setTel(rs.getString("tel"));
        teacher.setEmail(rs.getString("email"));
        teacher.setHomepage(rs.getString("hmpg"));
        teacher.setFacebook(rs.getString("fcbk"));
        teacher.setTwitter(rs.getString("twit"));
        return teacher;

        }
      } finally {
        conPool.returnConnection(con);
      }

  }
  
  public Teacher getByEmailPassword(String email, String password) throws Exception {
    HashMap<String, Object> valueMap = new HashMap<>();
    valueMap.put("email", email);
    valueMap.put("password", password);
    return teacherDao.selectOneByEmailPassword(valueMap);

  }
  
  
  public int add(Teacher teacher) throws Exception{
    memberDao.insert(teacher);
    teacherDao.insert(teacher):
      
    HashMap<String, Object> valueMap = new HashMap<>();
    valueMap.put("teacherNo",  teacher.getNo());
    
    for (String photoPath : teacher.getPhotoList()) {
      valueMap.put("photoPath",  photoPath);
      teacherDao.insertPhoto(valueMap);
    }
  }
  
  private void insertPhoto(int teacherNo, String photoPath) {
    HashMap<String, Object> valueMap = new HashMap<>();
    valueMap.put("teacherNo",  teacher.getNo());
    
    for (String photoPath : teacher.getPhotoList()) {
      valueMap.put("photoPath",  photoPath);
      teacherDao.insertPhoto(valueMap);
    }
  }
  
  public void insertPhoto(int no, List<String> photoList) throws Exception{
    Connection con = conPool.getConnection();
    try (
        PreparedStatement stmt = con.prepareStatement(
            "insert into tch_phot(tno, path) values(?,?)");) {
      
        for (String path : photoList) {
          stmt.setInt(1, no);
          stmt.setString(2, path);
          stmt.executeUpdate();
          
        }
        
      } finally {  
       conPool.returnConnection(con);
    }
  }
  
  public int delete(int no) throws Exception {
    Connection con = conPool.getConnection();
    try (
        PreparedStatement stmt = con.prepareStatement(
            "delete from tcher where tno=?");) {
          stmt.setInt(1, no);
          return stmt.executeUpdate();
          // 데이터를 삭제할 넘버를 받아서 sql문에 인파라미터에 그 숫자를 적재하고 delete하고 delete된 갯수를 리턴한다.
          
        } finally {  
          conPool.returnConnection(con);
        }
  }
  
  public int update(Teacher teacher) throws Exception {
    Connection con = conPool.getConnection();
    try (
        PreparedStatement stmt = con.prepareStatement(
            "update tcher set hmpg=?, fcbk=?, twit=? where tno=?");) {
      
        stmt.setString(1, teacher.getHomepage());
        stmt.setString(2, teacher.getFacebook());
        stmt.setString(3, teacher.getTwitter());
        stmt.setInt(4, teacher.getNo());
        
        return stmt.executeUpdate();

        
        } finally {  
          conPool.returnConnection(con);
        }
    
  }  
  public void deletePhoto(int teacherNo) throws Exception {
    Connection con = conPool.getConnection();
    try (
        PreparedStatement stmt = con.prepareStatement(
            "delete from tch_phot where tno=?");) {
          stmt.setInt(1, teacherNo);
          stmt.executeUpdate();
          
        } finally {  
          conPool.returnConnection(con);
        }
  }
}